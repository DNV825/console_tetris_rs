# Rustの学習ノート

## Rust開発環境の構築方法

### 必要なもの

以下のサイトから必要なものをダウンロードし、インストールする。

- [Rust公式サイト](https://www.rust-lang.org/ja)
- [Visual Studio Code](https://azure.microsoft.com/ja-jp/products/visual-studio-code/)、および以下の拡張機能
  - rust-analyzer（作者：The Rust Programming Language）
  - CodeLLDB（作者：Vadim Chugunov）

### Rustツールチェインのインストール手順

ツールチェインとは「ソフトウェア開発に必要な一連のツールセット」のことを言い、Rustツールチェインには

- Rustコンパイラ（rustc）
- ビルドツール兼パッケージマネージャー（Cargo）
- コンパイル済み標準ライブラリ など

が含まれる。

#### リンカのインストール

RustコンパイラはCコンパイラのリンカを利用するため、Rustをインストールする前にCコンパイラのリンカをインストールしなければならない。

LinuxでRustを利用する場合、以下のコマンドでCコンパイラをインストールすれば、同時にリンカもインストールできる。

```shell
# LinuxにRustをインストールする場合、Cコンパイラをインストールする。
$ sudo apt install build-essential
```

WindowsでRustを利用する場合、Rustのインストール時にVisual Studioを同時にインストールできるので、事前になにか行う必要はない（ただし、普通にインストールできない環境では公式サイトの特別な手順に従わなければならない）。

#### Rustツールチェインのインストール

公式サイトからRustツールチェインをダウンロードし、インストールする。

- Install Rust
  <https://www.rust-lang.org/ja/tools/install>

Windowsの場合、`rustup-init.exe`を実行して指示に従えばよい。

ただし、何も考えずにインストールを進めると、同時にVisual Studio 2022をインストールすることになる。個人でRustを使うのであればCommunity版を利用すればよいが、会社等で利用するのであれば「Visual Studio C++ Build tools」を利用する方法でインストールしなければならないだろう。

#### クロスビルドツールチェインのインストール

必要に応じてクロスビルド用のツールチェインをインストールする。例えば、Linux向けのAARCH64をターゲットにしたければ、以下のように`rustup`コマンドを実行すればよい。

```shell
# ターゲットを追加するコマンド。
$ rustup target add aarch64-unknown-linux-gnu
```

追加可能なターゲットは`rustup target list`で表示できる。

コマンドのヘルプは`rustup --help`で表示できるが、より詳しく`rustup`について知りたいのであれば [The rustup book](https://rust-lang.github.io/rustup/index.html) を参照すること。

#### Visual Studio Codeのインストール

エディタとしてVisual Studio Codeをインストールする。そして、以下の拡張機能をインストールすれば、Rustの環境構築は完了である。

- [Visual Studio Code](https://azure.microsoft.com/ja-jp/products/visual-studio-code/)、および以下の拡張機能
  - rust-analyzer（作者：The Rust Programming Language）
  - CodeLLDB（作者：Vadim Chugunov）

## cargoの使い方

cargoとは、Rustのビルドツール、およびパッケージマネージャーのこと。色々できるので、主だったところを紹介する。

| cargoコマンド | 効果 |
| --- | --- |
| `cargo new [オプション] <フォルダ名>` | 指定したフォルダを新規作成し、パッケージを構築する。 オプション指定なしだとバイナリクレート、`--lib`を指定するとライブラリクレートのパッケージとなる。 |
| `cargo init [オプション] <フォルダ名>` | 指定したフォルダへパッケージを構築する。 オプション指定なしだとバイナリクレート、`--lib`を指定するとライブラリクレートのパッケージとなる。 |
| `cargo check` | ソースコードの内容をチェックし、コンパイルエラーがあれば表示する。 |
| `cargo build` | ソースコードをビルドする。 |
| `cargo run` | ソースコードをビルドし、出来上がった実行可能ファイルを実行する。 |
| `cargo test [テスト名]` | テストを実行する。 |
| `cargo doc` | パッケージのドキュメントを出力する。 |

これらに加えてサブコマンド（`cargo install cargo-generate`のようなもの）まである。とりあえず、「何か色々できるのだなあ」と認識しておけばよいだろう。

## プロジェクト（パッケージ）の構成

Rustのプロジェクトは以下のような構成をとる。

| No | 用語 | 意味 |
| --- | --- | --- |
| (1) | パッケージ | クレートのビルド・テスト・共有を可能にするためのCargoの単位のこと。 |
| (2) | Cargo.toml | パッケージのメタデータや、パッケージをビルドするために必要な外部クレートへの依存関係を記述する。パッケージのマニフェストと呼ばれる。 |
| (3) | クレート | パッケージに1つのまとまりの機能を提供する単位で、ルートモジュールをトップとしたモジュールのツリーのこと。ルートモジュールが`main.rs`であれば実行バイナリ、それ以外の場合はライブラリを構成する。 |
| (4) | モジュール | クレート内でプログラムを構造化したもの。構造体や関数などのスコープや可視性を制御する。 |
| (5) | 外部クレート | 主に [crates.io](https://crates.io/) で公開されているクレートのこと。 |
| (6) | stdクレート | Rustの標準ライブラリを提供するクレートのこと。 |

![./img/rust_basic.png](./img/rust_basic.png)

## Rustの文法

## 組み込み機器向けにRustを利用するための情報

### 標準ライブラリの構造

Rustの標準ライブラリは以下の3レベル構造で提供されている。

![./img/3level_structure_std_library.png](./img/3level_structure_std_library.png)

`core`クレートと`alloc`クレートは`std`クレートのサブセットである。

最も下層の`core`クレートは前提条件なしで利用できる。ただし、整数型やスライスのようなプリミティブ型や、アトミック操作のようなプロセッサ機能を利用する処理しか提供されていない（OSやCPUといったプラットフォームに依存しない処理しか提供されていない）。

`alloc`クレートは`Box`型や`Vec`型といったヒープメモリを利用する型を提供する。`alloc`クレートを利用するには、メモリアロケーターの実装が必要となる。

`std`クレートはファイルシステムやネットワーク、スレッドといったOS機能を提供する。`println!`マクロやコマンドライン引数を渡すインターフェースも`std`クレートの役割である。`std`クレートを利用するためにはOSが必要となる。

通常は考慮不要だが、OSが載っていない組み込み機器向けにアプリケーションを作成する際には、これらを考慮しなければならない。

### unsafeブロック

FPGAボードなどを利用する際はハードウェアを直接制御することになるが、その場合「Rustコンパイラが安全でないとみなすコード」を記述する必要がある。そのために利用するのがunsafeブロックで、以下のように記述する。もちろん、記述内容の安全性は記述者であるプログラマーが保証しなければならない。

```rust
unsafe {
  // 安全でない操作を記述できる。
  // 操作の安全性はプログラマーが保障する。
}
```

なお、どんなコードでも書けるわけではなく、以下の5つの動作のみが許されている。

1. ハードウェア（メモリ）の直接操作
1. 可変なグローバル変数（static mut）へのアクセス
1. 安全でない関数（C言語の関数など）を呼び出す
1. unsafeなトレイトを実装する
1. Unionへアクセスする

メモリマップドIOを操作するために、特に1番目の操作が重要となる。

## 参考資料

### 参考文献

1. 中林 智之 / 井田 健太, 基礎から学ぶ組込みRust, 株式会社シーアンドアール研究所, 2021/04/30 初版発行, ISBN978-4-86354-337-9 C3055
1. クジラ飛行机, 手を動かして考えればよくわかる 高効率言語Rust書き方・作り方, ソシム株式会社, 2022/02/08 初版第2刷発行, ISBN978-4-8026-1351-4

### Rust公式資料

1. -, The rustup book, -, -, <https://rust-lang.github.io/rustup/index.html>
1. -, The Cargo Book, -, -, <https://doc.rust-lang.org/cargo/index.html>
